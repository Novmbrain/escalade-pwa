{"id":"PWA-app-bwi","title":"Face Image 操作警告机制","description":"增强编辑器岩面管理的删除和覆盖上传流程：\n- 删除岩面时级联清除关联线路的 topoLine 标注\n- 覆盖上传时让用户选择是否保留 topoLine 标注\n- 两种场景都显示受影响线路列表作为警告","status":"open","priority":2,"issue_type":"epic","owner":"fuwenjiexidian@gmail.com","created_at":"2026-02-05T09:10:21.533627+01:00","created_by":"Wenjie FU","updated_at":"2026-02-05T09:10:21.533627+01:00"}
{"id":"PWA-app-bwi.1","title":"US-001: 删除岩面 API 级联清除 topoLine","description":"删除岩面时，除了解除线路的 faceId 关联，还需一并清除 topoLine 标注坐标。\n\n## 修改文件\n- src/app/api/faces/route.ts — DELETE handler\n\n## 变更内容\n当前代码 (line ~240):\n  { $unset: { faceId: '' } }\n\n改为:\n  { $unset: { faceId: '', topoLine: '' } }\n\n## Acceptance Criteria\n- [ ] DELETE /api/faces 删除岩面后，关联线路的 faceId 和 topoLine 均被清除\n- [ ] 返回的 routesCleared 数量正确\n- [ ] npm run lint passes\n- [ ] npx tsc --noEmit passes\n- [ ] npm run test:run passes","status":"closed","priority":1,"issue_type":"task","owner":"fuwenjiexidian@gmail.com","created_at":"2026-02-05T09:10:33.330845+01:00","created_by":"Wenjie FU","updated_at":"2026-02-06T01:21:40.397112+01:00","closed_at":"2026-02-06T01:21:40.397112+01:00","close_reason":"Implemented: added topoLine to $unset in DELETE /api/faces handler. All tests pass.","dependencies":[{"issue_id":"PWA-app-bwi.1","depends_on_id":"PWA-app-bwi","type":"parent-child","created_at":"2026-02-05T09:10:33.332513+01:00","created_by":"Wenjie FU"}]}
{"id":"PWA-app-bwi.2","title":"US-002: 上传 API 支持可选清除 topoLine","description":"覆盖上传岩面图片时，允许调用方指定是否清除该岩面关联线路的 topoLine 标注。\n\n## 修改文件\n- src/app/api/upload/route.ts — POST handler\n\n## 变更内容\n1. 从 FormData 中读取可选参数 clearTopoLines (string 'true'/'false')\n2. 上传成功后，如果 clearTopoLines === 'true'：\n   - 查询 routes collection: { cragId, faceId, topoLine: { $exists: true } }\n   - 执行 updateMany: { $unset: { topoLine: '' } }\n3. 返回 response 中增加 topoLinesCleared 字段\n\n## Acceptance Criteria\n- [ ] POST /api/upload 接受 clearTopoLines FormData 参数\n- [ ] clearTopoLines=true 时，上传成功后清除关联线路的 topoLine\n- [ ] clearTopoLines=false 或未传时，不清除 topoLine（保持现有行为）\n- [ ] 返回 JSON 包含 topoLinesCleared 计数\n- [ ] npm run lint passes\n- [ ] npx tsc --noEmit passes\n- [ ] npm run test:run passes","status":"open","priority":1,"issue_type":"task","owner":"fuwenjiexidian@gmail.com","created_at":"2026-02-05T09:10:46.556303+01:00","created_by":"Wenjie FU","updated_at":"2026-02-06T01:15:45.411058+01:00","dependencies":[{"issue_id":"PWA-app-bwi.2","depends_on_id":"PWA-app-bwi","type":"parent-child","created_at":"2026-02-05T09:10:46.557411+01:00","created_by":"Wenjie FU"}]}
{"id":"PWA-app-bwi.3","title":"US-003: 增强删除确认弹窗显示受影响线路","description":"删除岩面时，如果有线路在该岩面上标注了 Topo 路线，在确认弹窗中显示受影响线路列表，\n明确告知用户这些线路的 Topo 标注将被清除。\n\n## 修改文件\n- src/app/[locale]/editor/faces/page.tsx — showDeleteConfirm 弹窗部分\n\n## 变更内容\n1. 在弹窗打开时，从 useCragRoutes() 已有数据中过滤出：\n   routes.filter(r =\u003e r.faceId === selectedFace \u0026\u0026 r.topoLine?.length \u003e 0)\n2. 如果有受影响线路，在弹窗中显示：\n   - 受影响线路列表（名称 + 难度）\n   - 说明文案：\"线路本身不会被删除，仅解除岩面关联并清除路线标注\"\n3. 如果无受影响线路，保持原有简单确认弹窗\n\n## UI 设计\n使用项目现有的自定义 modal 模式（fixed 定位 + theme 变量）。\n受影响线路区域使用 surface-variant 背景的圆角卡片展示。\n\n## Acceptance Criteria\n- [ ] 删除有 topoLine 标注线路的岩面时，弹窗显示受影响线路列表\n- [ ] 线路列表显示名称和难度等级\n- [ ] 弹窗明确告知 Topo 标注将被清除\n- [ ] 删除无 topoLine 标注线路的岩面时，弹窗与原有行为一致\n- [ ] 弹窗样式符合项目 theme 变量设计规范\n- [ ] npm run lint passes\n- [ ] npx tsc --noEmit passes\n- [ ] npm run test:run passes","status":"open","priority":2,"issue_type":"task","owner":"fuwenjiexidian@gmail.com","created_at":"2026-02-05T09:10:58.551117+01:00","created_by":"Wenjie FU","updated_at":"2026-02-05T09:10:58.551117+01:00","dependencies":[{"issue_id":"PWA-app-bwi.3","depends_on_id":"PWA-app-bwi","type":"parent-child","created_at":"2026-02-05T09:10:58.552552+01:00","created_by":"Wenjie FU"},{"issue_id":"PWA-app-bwi.3","depends_on_id":"PWA-app-bwi.1","type":"blocks","created_at":"2026-02-05T09:11:20.868578+01:00","created_by":"Wenjie FU"}]}
{"id":"PWA-app-bwi.4","title":"US-004: 增强覆盖上传确认弹窗支持 topoLine 选择","description":"覆盖上传岩面图片时，如果有线路在该岩面上标注了 Topo 路线，在确认弹窗中：\n1. 显示受影响线路列表\n2. 提供 radio 选择：保留标注 / 清除标注\n\n## 修改文件\n- src/app/[locale]/editor/faces/page.tsx — showOverwriteConfirm 弹窗部分 + doUpload 调用\n\n## 变更内容\n1. 新增状态 clearTopoOnUpload: boolean (默认 false)\n2. 弹窗打开时，从 useCragRoutes() 已有数据中过滤出有 topoLine 的线路\n3. 如果有受影响线路，在弹窗中显示：\n   - 受影响线路列表（名称 + 难度）\n   - Radio 选择：\n     ○ 保留标注（新照片角度与原图相同时选择）\n     ○ 清除标注，稍后重新标注（新照片角度不同时选择）\n4. doUpload() 调用时将 clearTopoOnUpload 值作为 clearTopoLines 传入 FormData\n5. 如果无受影响线路，保持原有简单确认弹窗\n\n## UI 设计\n使用项目现有的自定义 modal 模式（fixed 定位 + theme 变量）。\nRadio 选项使用 div + border 高亮，不依赖原生 radio 样式。\n受影响线路区域使用 surface-variant 背景的圆角卡片展示。\n\n## Acceptance Criteria\n- [ ] 覆盖有 topoLine 标注线路的岩面时，弹窗显示受影响线路列表\n- [ ] 弹窗包含\"保留标注\"和\"清除标注\"两个 radio 选项\n- [ ] 默认选中\"保留标注\"\n- [ ] 选择\"清除标注\"后上传，关联线路的 topoLine 被清除\n- [ ] 选择\"保留标注\"后上传，topoLine 不受影响\n- [ ] 覆盖无 topoLine 标注线路的岩面时，弹窗与原有行为一致\n- [ ] 弹窗样式符合项目 theme 变量设计规范\n- [ ] npm run lint passes\n- [ ] npx tsc --noEmit passes\n- [ ] npm run test:run passes","status":"open","priority":2,"issue_type":"task","owner":"fuwenjiexidian@gmail.com","created_at":"2026-02-05T09:11:11.009148+01:00","created_by":"Wenjie FU","updated_at":"2026-02-06T01:15:46.126173+01:00","dependencies":[{"issue_id":"PWA-app-bwi.4","depends_on_id":"PWA-app-bwi","type":"parent-child","created_at":"2026-02-05T09:11:11.010763+01:00","created_by":"Wenjie FU"},{"issue_id":"PWA-app-bwi.4","depends_on_id":"PWA-app-bwi.2","type":"blocks","created_at":"2026-02-05T09:11:20.941553+01:00","created_by":"Wenjie FU"}]}
