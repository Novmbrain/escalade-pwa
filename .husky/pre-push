#!/usr/bin/env sh

# Pre-push hook: å¹¶è¡Œæ‰§è¡Œ CI æ£€æŸ¥ï¼ˆESLint å·²åœ¨ pre-commit å®Œæˆï¼‰
# è¿è¡Œ TypeScript + Vitest + Playwright å¹¶è¡Œ

set -e

echo ""
echo "ğŸš€ Running local CI before push..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Stash uncommitted changes to test committed code only
if ! git diff --quiet || ! git diff --cached --quiet; then
  git stash push --keep-index --include-untracked -q -m "pre-push-hook"
  STASHED=1
else
  STASHED=0
fi

# Cleanup function
cleanup() {
  if [ "$STASHED" = "1" ]; then
    git stash pop -q 2>/dev/null || true
  fi
  # Kill background jobs on exit
  jobs -p | xargs -r kill 2>/dev/null || true
}
trap cleanup EXIT

# Create temp files for capturing results
TMPDIR=$(mktemp -d)
TSC_LOG="$TMPDIR/tsc.log"
VITEST_LOG="$TMPDIR/vitest.log"
PLAYWRIGHT_LOG="$TMPDIR/playwright.log"

echo ""
echo "âš¡ Running checks in parallel..."
echo ""

# Run all checks in parallel
(
  echo "ğŸ“˜ TypeScript..."
  if pnpm run typecheck > "$TSC_LOG" 2>&1; then
    echo "TSC_PASS" >> "$TSC_LOG"
  fi
) &
TSC_PID=$!

(
  echo "ğŸ§ª Vitest..."
  if pnpm run test:run > "$VITEST_LOG" 2>&1; then
    echo "VITEST_PASS" >> "$VITEST_LOG"
  fi
) &
VITEST_PID=$!

(
  echo "ğŸ­ Playwright..."
  if pnpm run test:ct > "$PLAYWRIGHT_LOG" 2>&1; then
    echo "PLAYWRIGHT_PASS" >> "$PLAYWRIGHT_LOG"
  fi
) &
PLAYWRIGHT_PID=$!

# Wait for all and collect results
FAILED=0

wait $TSC_PID || true
if grep -q "TSC_PASS" "$TSC_LOG" 2>/dev/null; then
  echo "   âœ… TypeScript passed"
else
  echo "   âŒ TypeScript failed"
  cat "$TSC_LOG" 2>/dev/null | grep -v "TSC_PASS" | head -20
  FAILED=1
fi

wait $VITEST_PID || true
if grep -q "VITEST_PASS" "$VITEST_LOG" 2>/dev/null; then
  # Extract test count
  TESTS=$(grep -oE "[0-9]+ passed" "$VITEST_LOG" 2>/dev/null | tail -1 || echo "")
  echo "   âœ… Vitest passed ${TESTS}"
else
  echo "   âŒ Vitest failed"
  cat "$VITEST_LOG" 2>/dev/null | grep -v "VITEST_PASS" | tail -30
  FAILED=1
fi

wait $PLAYWRIGHT_PID || true
if grep -q "PLAYWRIGHT_PASS" "$PLAYWRIGHT_LOG" 2>/dev/null; then
  # Extract test count
  TESTS=$(grep -oE "[0-9]+ passed" "$PLAYWRIGHT_LOG" 2>/dev/null | tail -1 || echo "")
  echo "   âœ… Playwright passed ${TESTS}"
else
  echo "   âŒ Playwright failed"
  cat "$PLAYWRIGHT_LOG" 2>/dev/null | grep -v "PLAYWRIGHT_PASS" | tail -30
  FAILED=1
fi

# Cleanup temp files
rm -rf "$TMPDIR"

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if [ "$FAILED" -ne 0 ]; then
  echo "âŒ Local CI failed. Push aborted."
  echo ""
  echo "ğŸ’¡ To skip (not recommended): git push --no-verify"
  exit 1
fi

echo "âœ… All checks passed!"
echo ""
