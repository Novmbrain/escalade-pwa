#!/usr/bin/env sh

# Pre-push hook: å®Œæ•´æœ¬åœ° CIï¼ˆæ›¿ä»£ GitHub Actionsï¼‰
# è¿è¡Œ ESLint + TypeScript + Vitest + Playwright

set -e

echo ""
echo "ğŸš€ Running local CI before push..."
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# Stash uncommitted changes to test committed code only
if ! git diff --quiet || ! git diff --cached --quiet; then
  git stash push --keep-index --include-untracked -q -m "pre-push-hook"
  STASHED=1
else
  STASHED=0
fi

# Cleanup function
cleanup() {
  if [ "$STASHED" = "1" ]; then
    git stash pop -q 2>/dev/null || true
  fi
}
trap cleanup EXIT

# Track failures
FAILED=0

# 1. ESLint
echo ""
echo "ğŸ” [1/4] ESLint..."
if npm run lint --silent; then
  echo "   âœ… ESLint passed"
else
  echo "   âŒ ESLint failed"
  FAILED=1
fi

# 2. TypeScript
echo ""
echo "ğŸ“˜ [2/4] TypeScript..."
if npx tsc --noEmit; then
  echo "   âœ… TypeScript passed"
else
  echo "   âŒ TypeScript failed"
  FAILED=1
fi

# 3. Vitest (å•å…ƒæµ‹è¯•)
echo ""
echo "ğŸ§ª [3/4] Vitest..."
if npm run test:run --silent; then
  echo "   âœ… Vitest passed"
else
  echo "   âŒ Vitest failed"
  FAILED=1
fi

# 4. Playwright (ç»„ä»¶æµ‹è¯•)
echo ""
echo "ğŸ­ [4/4] Playwright..."
if npm run test:ct --silent 2>/dev/null; then
  echo "   âœ… Playwright passed"
else
  echo "   âŒ Playwright failed"
  FAILED=1
fi

echo ""
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

if [ "$FAILED" -ne 0 ]; then
  echo "âŒ Local CI failed. Push aborted."
  echo ""
  echo "ğŸ’¡ To skip (not recommended): git push --no-verify"
  exit 1
fi

echo "âœ… All checks passed!"
echo ""
