## Ralph Loop Progress

### Iteration 1 — 2026-02-06
**Task**: PWA-app-bwi.1 (US-001): 删除岩面 API 级联清除 topoLine
**Status**: COMPLETED
**Changes**:
- Modified `src/app/api/faces/route.ts` line 240: added `topoLine: ''` to `$unset` operator
- When a face image is deleted, associated routes now have both `faceId` and `topoLine` cleared
**Verification**:
- TypeScript: PASS (npx tsc --noEmit)
- ESLint: PASS (no new errors introduced)
- Tests: PASS (52 files, 693 tests all passing)

### Iteration 2 (Ralph Loop 1) — 2026-02-06
**Task**: PWA-app-bwi.2 (US-002): 上传 API 支持可选清除 topoLine
**Status**: COMPLETED
**Changes**:
- Modified `src/app/api/upload/route.ts`:
  - Added `getDatabase` import from `@/lib/db`
  - Read optional `clearTopoLines` FormData parameter
  - After successful upload, if `clearTopoLines === 'true'` and faceId exists, clear topoLine on matching routes
  - Added `topoLinesCleared` count to response JSON and log metadata
**Verification**:
- TypeScript: PASS
- ESLint: PASS
- Tests: PASS (52 files, 693 tests all passing)

### Iteration 3 (Ralph Loop 2) — 2026-02-06
**Task**: PWA-app-bwi.3 (US-003): 增强删除确认弹窗显示受影响线路
**Status**: COMPLETED
**Changes**:
- Modified `src/app/[locale]/editor/faces/page.tsx` delete confirmation dialog:
  - Filter routes with `topoLine?.length > 0` as affected routes
  - Display affected route names and grades in a surface-variant card
  - Show warning text explaining topoLine annotations will be cleared
  - When no routes have topoLine, dialog behaves same as before
**Verification**:
- TypeScript: PASS
- ESLint: PASS
- Tests: PASS (52 files, 693 tests all passing)

### Iteration 4 (Ralph Loop 3) — 2026-02-06
**Task**: PWA-app-bwi.4 (US-004): 增强覆盖上传确认弹窗支持 topoLine 选择
**Status**: COMPLETED
**Changes**:
- Modified `src/app/[locale]/editor/faces/page.tsx`:
  - Added `clearTopoOnUpload` state (default false)
  - Overwrite confirmation dialog now shows affected routes with topoLine
  - Added radio-style buttons: "保留现有标注" / "清除标注，稍后重新标注"
  - `doUpload()` passes `clearTopoLines` FormData param based on user choice
  - Reset `clearTopoOnUpload` on successful upload and cancel
  - When no routes have topoLine, dialog behaves same as before
**Verification**:
- TypeScript: PASS
- ESLint: PASS
- Tests: PASS (52 files, 693 tests all passing)
